name: assignment4

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Log File (Lines 1 & 2)
        run: |
          echo "$(date -Iminutes)" > log.txt
          echo "Nathaniel Zerah" >> log.txt

      - name: Build Pet Store Image
        id: build_store
        run: |
          docker build -t pet-store:latest ./pet-store
          echo "image pet-store successfully built" >> log.txt
        continue-on-error: true

      - name: Build Pet Order Image
        id: build_order
        run: |
          docker build -t pet-order:latest ./pet-order
          echo "image pet-order successfully built" >> log.txt
        continue-on-error: true

      - name: Handle Build Failures
        if: steps.build_store.outcome == 'failure' || steps.build_order.outcome == 'failure'
        run: |
          if [ "${{ steps.build_store.outcome }}" == "failure" ]; then echo "image pet-store not able to be built" >> log.txt; fi
          if [ "${{ steps.build_order.outcome }}" == "failure" ]; then echo "image pet-order not able to be built" >> log.txt; fi
      
      - name: Save Docker Images
        run: |
          docker save pet-store:latest -o pet-store.tar
          docker save pet-order:latest -o pet-order.tar

      - name: Upload Artifacts (Log & Images)
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            log.txt
            pet-store.tar
            pet-order.tar

  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Load Docker Images
        run: |
          docker load -i pet-store.tar
          docker load -i pet-order.tar

      - name: Run Containers
        id: run_containers
        run: |
          # Network setup
          docker network create pet-net

          # Databases (Two instances as per slide 4)
          docker run -d --name mongo-store --network pet-net mongo:latest
          docker run -d --name mongo-order --network pet-net mongo:latest

          # Pet Stores (Port 8000 mapped to 5001/5002)
          docker run -d --name pet-store1 --network pet-net -p 5001:8000 -e STORE_ID=1 -e DB_URI="mongodb://mongo-store:27017" -e NINJA_API_KEY="key" pet-store:latest
          docker run -d --name pet-store2 --network pet-net -p 5002:8000 -e STORE_ID=2 -e DB_URI="mongodb://mongo-store:27017" -e NINJA_API_KEY="key" pet-store:latest

          # Pet Order (Port 8080 mapped to 5003)
          docker run -d --name pet-order --network pet-net -p 5003:8080 \
            -e MONGO_URI="mongodb://mongo-order:27017" \
            -e PETSTORE1_URL="http://pet-store1:8000" \
            -e PETSTORE2_URL="http://pet-store2:8000" \
            -e NINJA_API_KEY="key" \
            pet-order:latest
          
          sleep 10 # Wait for startup
          
          # Check health
          if [ $(docker inspect -f '{{.State.Running}}' pet-store1) = "true" ] && \
             [ $(docker inspect -f '{{.State.Running}}' pet-store2) = "true" ] && \
             [ $(docker inspect -f '{{.State.Running}}' pet-order) = "true" ]; then
             echo "Container pet-store #1 up and running" >> log.txt
             echo "Container pet-store #2 up and running" >> log.txt
             echo "Container pet-order up and running" >> log.txt
          else
             echo "Container failed to run" >> log.txt
             exit 1
          fi

      - name: Run Pytest
        id: pytest
        run: |
          pip install pytest requests
          # Run tests and capture output to assn4_test_results.txt
          pytest -v tests/assn4_tests.py > assn4_test_results.txt 2>&1 || true
          
          # Check if tests passed for log.txt
          if grep -q "failed" assn4_test_results.txt; then
            echo "pytests failed" >> log.txt
            # Fail the job if tests failed, but ensure artifacts upload
            exit 1 
          else
            echo "All pytests succeeded" >> log.txt
          fi

      - name: Upload Test Results and Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            assn4_test_results.txt
            log.txt

  query:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Load Images
        run: |
          docker load -i pet-store.tar
          docker load -i pet-order.tar

      - name: Start Environment (Same as Test)
        run: |
          docker network create pet-net
          docker run -d --name mongo-store --network pet-net mongo:latest
          docker run -d --name mongo-order --network pet-net mongo:latest
          docker run -d --name pet-store1 --network pet-net -p 5001:8000 -e STORE_ID=1 -e DB_URI="mongodb://mongo-store:27017" -e NINJA_API_KEY="key" pet-store:latest
          docker run -d --name pet-store2 --network pet-net -p 5002:8000 -e STORE_ID=2 -e DB_URI="mongodb://mongo-store:27017" -e NINJA_API_KEY="key" pet-store:latest
          docker run -d --name pet-order --network pet-net -p 5003:8080 \
            -e MONGO_URI="mongodb://mongo-order:27017" \
            -e PETSTORE1_URL="http://pet-store1:8000" \
            -e PETSTORE2_URL="http://pet-store2:8000" \
            -e NINJA_API_KEY="key" \
            pet-order:latest
          sleep 10

      - name: Execute Query Job
        run: |
          pip install requests
          python query_runner.py

      - name: Upload Response
        uses: actions/upload-artifact@v4
        with:
          name: query-results
          path: response.txt